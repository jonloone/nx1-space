<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ground Station Intelligence - Kepler.gl</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css">
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: ff-clan-web-pro, 'Helvetica Neue', Helvetica, sans-serif;
        }
        #app {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@16.8.4/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js"></script>
    
    <!-- Redux -->
    <script crossorigin src="https://unpkg.com/redux@4.0.5/dist/redux.js"></script>
    <script crossorigin src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js"></script>
    
    <!-- Kepler.gl and dependencies -->
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js"></script>
    <script src="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.js"></script>

    <script>
        // Wait for all scripts to load
        window.addEventListener('load', function() {
            console.log('Initializing Kepler.gl...');
            
            const { Provider, connect } = ReactRedux;
            const { createStore, combineReducers } = Redux;
            const h = React.createElement;

            // Simple Redux setup without middleware
            const reducers = combineReducers({
                keplerGl: KeplerGl.keplerGlReducer
            });

            const store = createStore(reducers);

            // Map component
            class Map extends React.Component {
                componentDidMount() {
                    console.log('Loading ground station data...');
                    this.loadData();
                }

                loadData = () => {
                    fetch('/data/kepler_ground_stations.json')
                        .then(res => res.json())
                        .then(rawData => {
                            console.log('Data loaded, preparing for Kepler.gl...');
                            
                            // Use the data structure from our file
                            const processedData = {
                                info: {
                                    label: 'Commercial Ground Stations',
                                    id: 'ground-stations'
                                },
                                data: rawData.data.allData
                            };
                            
                            // Simple config focusing on essential settings
                            const config = {
                                version: 'v1',
                                config: {
                                    visState: {
                                        filters: [],
                                        layers: [{
                                            id: 'ground-stations-layer',
                                            type: 'point',
                                            config: {
                                                dataId: 'ground-stations',
                                                label: 'Ground Stations',
                                                columns: {
                                                    lat: 'latitude',
                                                    lng: 'longitude'
                                                },
                                                isVisible: true,
                                                visConfig: {
                                                    radius: 20,
                                                    fixedRadius: false,
                                                    opacity: 0.8,
                                                    outline: false,
                                                    thickness: 2,
                                                    colorRange: {
                                                        name: 'Global Warming',
                                                        type: 'sequential',
                                                        category: 'Uber',
                                                        colors: [
                                                            '#5A1846',
                                                            '#900C3F', 
                                                            '#C70039',
                                                            '#E3611C',
                                                            '#F1920E',
                                                            '#FFC300'
                                                        ]
                                                    },
                                                    radiusRange: [5, 50],
                                                    filled: true
                                                },
                                                colorField: {
                                                    name: 'overall_investment_score',
                                                    type: 'real'
                                                },
                                                colorScale: 'quantile',
                                                sizeField: {
                                                    name: 'overall_investment_score',
                                                    type: 'real'
                                                },
                                                sizeScale: 'linear'
                                            }
                                        }],
                                        interactionConfig: {
                                            tooltip: {
                                                fieldsToShow: {
                                                    'ground-stations': ['name', 'operator', 'country', 'overall_investment_score']
                                                },
                                                enabled: true
                                            }
                                        },
                                        layerBlending: 'normal',
                                        splitMaps: []
                                    },
                                    mapState: {
                                        bearing: 0,
                                        dragRotate: false,
                                        latitude: 20,
                                        longitude: 0,
                                        pitch: 0,
                                        zoom: 2,
                                        isSplit: false
                                    },
                                    mapStyle: {
                                        styleType: 'dark',
                                        topLayerGroups: {},
                                        visibleLayerGroups: {
                                            label: true,
                                            road: false,
                                            border: false,
                                            building: true,
                                            water: true,
                                            land: true
                                        }
                                    }
                                }
                            };
                            
                            console.log('Dispatching data to Kepler.gl...');
                            
                            // Dispatch action
                            this.props.dispatch(
                                KeplerGl.addDataToMap({
                                    datasets: processedData,
                                    option: {
                                        centerMap: true,
                                        readOnly: false
                                    },
                                    config: config
                                })
                            );
                            
                            console.log('Data dispatch complete');
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            alert('Error loading data: ' + err.message);
                        });
                }

                render() {
                    return h(KeplerGl.default, {
                        id: 'ground-stations',
                        mapboxApiAccessToken: 'pk.eyJ1IjoidWJlcmRhdGEiLCJhIjoiY2p5aHB5bzEzMDI3MjNucWx4dmhvbW5wYyJ9.ZjLMWjog4imdrZhtheCOtA',
                        width: window.innerWidth,
                        height: window.innerHeight
                    });
                }
            }

            // Connect component
            const ConnectedMap = connect(state => state)(Map);

            // App component  
            const App = () => {
                return h(Provider, { store: store },
                    h(ConnectedMap)
                );
            };

            // Render
            ReactDOM.render(h(App), document.getElementById('app'));
            console.log('Kepler.gl initialized');
        });
    </script>
</body>
</html>