<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ground Station Intelligence - Kepler.gl</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css">
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #app {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@16.8.4/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js"></script>
    
    <!-- Redux -->
    <script crossorigin src="https://unpkg.com/redux@4.0.5/dist/redux.js"></script>
    <script crossorigin src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js"></script>
    
    <!-- Kepler.gl and dependencies -->
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js"></script>
    <script src="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.js"></script>

    <script>
        // Create app after all dependencies load
        window.addEventListener('load', function() {
            const { Provider, connect } = ReactRedux;
            const { createStore, combineReducers, applyMiddleware, compose } = Redux;
            const h = React.createElement;

            // Initialize Kepler.gl reducer
            const customizedKeplerGlReducer = KeplerGl.keplerGlReducer.initialState({
                uiState: {
                    activeSidePanel: null,
                    currentModal: null
                }
            });

            const reducers = combineReducers({
                keplerGl: customizedKeplerGlReducer
            });

            // Create store
            const store = createStore(reducers, {});

            // Map component
            class Map extends React.Component {
                componentDidMount() {
                    // Load data after component mounts
                    this.loadData();
                }

                loadData = () => {
                    // Fix: Use the correct path to the data file
                    fetch('/data/kepler_ground_stations.json')
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            console.log('Data loaded successfully:', data);
                            
                            // Dispatch data to Kepler
                            this.props.dispatch(
                                KeplerGl.addDataToMap({
                                    datasets: {
                                        info: {
                                            label: 'Commercial Ground Stations',
                                            id: 'ground-stations'
                                        },
                                        data: data.data.allData
                                    },
                                    option: {
                                        centerMap: true,
                                        readOnly: false
                                    },
                                    config: data.config
                                })
                            );
                        })
                        .catch(err => {
                            console.error('Error loading data:', err);
                            alert('Error loading ground station data: ' + err.message);
                        });
                }

                render() {
                    return h(KeplerGl.default, {
                        id: 'ground-stations',
                        // Using Kepler.gl's public demo token
                        mapboxApiAccessToken: 'pk.eyJ1IjoidWJlcmRhdGEiLCJhIjoiY2p5aHB5bzEzMDI3MjNucWx4dmhvbW5wYyJ9.ZjLMWjog4imdrZhtheCOtA',
                        width: window.innerWidth,
                        height: window.innerHeight
                    });
                }
            }

            // Connect component to Redux
            const ConnectedMap = connect(state => state)(Map);

            // Root component
            const App = () => {
                return h(Provider, { store: store },
                    h('div', { style: { position: 'absolute', width: '100%', height: '100%' } },
                        h(ConnectedMap)
                    )
                );
            };

            // Render app
            ReactDOM.render(h(App), document.getElementById('app'));
        });
    </script>
</body>
</html>